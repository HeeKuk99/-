# capstone_design
프로젝트 주제 : 유방암 HRA(Health Risk Appraisal) 모델의 구축 및 서비스 앱 구현
프로젝트 기간 : 2024.3 - 2024.6

프로젝트 목적 : 유방암은 여성들 사이에서 가장 흔한 종양성 질환 중 하나로, 예방과 함께 조기 치료의 중요성이 강조되고 있다. 본 프로젝트에서는 국내 데이터를 활용하여 유방암 위험도 예측 모델의 구축과 서비스 어플리케이션 프로토타입을 개발하였다.

활용 데이터 : 국립 암센터의 가상 데이터와 직접 수집한 대조군 데이터를 전처리

프로젝트 내용 : 랜덤 포레스트와 그래디언트 부스팅 모델을 활용하여 임계값 0.01 과 0.05를 기준으로 두 개의 위험 요인 집합을 선택하였다. 그 후, 선정된 요인을 기반으로 유방암 위험도 예측을 위해 랜덤 포레스트,그래디언트 부스팅, 인공신경망, 로지스틱 회귀 네 가지 모델을 학습시켰다. 모델의 변수 중요도를 고려하여 각각의 인스턴스에 대한 예측 확률을 계산하고, 최종적으로 유방암 위험 점수를 산출하였다. 실험 결과, 임계값 0.01 이상의 모델들은 그래디언트 부스팅이 높은 Accuracy, Precision, F1 Score, ROC AUC를 보였으며, 임계값 0.05 이상의 모델들에 대해서는 랜덤 포레스트가 우수한 결과를 나타냈다. 마지막으로, 최종 선정된 모델을 기반으로 국내 이용자의 편의를 고려하여 한국어 유방 건강 어플 프로토타입을 개발하였다. 

## 데이터 수집
 유방암 환자군 데이터로는 국립암센터의 유방암 환자군의 Fake Data를, 대조군 데이터는 자체 설문조사를 진행하여 확보한 151명의 데이터를 선정하였다.
 
### A. 환자군 데이터
 Fake Data는 국립 암센터에서 제공하는 암라이브러리 데이터 체험을 위한 가상 데이터이다. 국립암센터는 원천 데이터 사용의 제약성으로 인해 데이터 개방 및 활용이 어렵기 때문에, 실제 데이터에 기반해 만들어낸 가상 데이터로 인공지능의 개발 활성화를 지향한다고 서술한 바 있다.
 
### B. 대조군 데이터
 설문지는 유방암 발생 위험요인에 관한 문항과 개인 특성에 관한 문항으로 이루어져 있으며 본 프로젝트 팀원들이 작성하였다. 나이, 키 등 개인 특성 6문항, 인식 조사 11문항, 초경 연령, 출산 여부 등 위험요인 18 문항등을 포함하여 전체 37 문항으로 구성되어있다. 해당 설문은 14일동안 내국인을 대상으로 다른 제약조건 없이 인터넷 설문을 통해 진행되었고, 그 결과 151개의 응답을 수집할 수 있었다.
 
## 데이터 전처리
 최종 데이터는 다음과 같은 방법으로 구성되었다.
 
### A. 환자군 데이터 구성 
 제공받은 Fake Data내에서 입원일자, 유방암 수술경력등 유방암을 진단 받은 이후의 정보와 관련된 칼럼들을 
제외하였으며, 대조군 데이터를 수집할 때 ‘호르몬 치료를 받은 적 있냐’에 대한 응답을 받은 것을 기반으로, 환자군 데이터에도 호르몬, 방사선 치료 ‘여부’에 대한 칼럼을 임의로 추가하였다.  데이터 완전성을 위해 환자군 데이터 내 결측치가 다수인 행을 제거했고, 데이터의 고유성을 위하여 중복된 행 역시 제거했다.

### B.  대조군 데이터 구성 
 설문조사를 통해 얻은 데이터들을 TGAN 모델에 학습시켜 12000개의 데이터를 만들었다. 이 때, 설문조사 
응답이 극소수로 존재하는 폐경, 암 유경험 등의 데이터는 학습이 불가해 제외하고 학습하였다. 최종적으로 증강과정 데이터에 포함된 칼럼은 나이, 체중, 흡연여부 등 14 개 칼럼이다.
 이후, 환자군 데이터와 대조하여 없는 칼럼을 생성하고 환자군 데이터에 합친 뒤, K-최근접 이웃법을 이용하여 호르몬 치료 기간, 개인 병력 여부 등 대조군 데이터에 존재하지 않는 칼럼의 데이터들을 대체했다. 

 이로부터 TARGET 여부 미포함 총 65개 칼럼의 23807개 데이터로 최종 데이터를 구성하였다.

## 유방암 위험요인분류
  최종 데이터를 Random Forest(RF), Gradient Boosting(GB) 모델에 각각 학습시켰다. 이 때, 학습률, 트리의 최대 깊이 등 모델의 하이퍼 파라미터를 실험적으로 조정하며 모델의 학습 정확도를 높이고자 하였다.
  모델 학습을 위한 train set과 test set을 나눌 때, 각 칼럽에 대해서 나이, BMI 등의 분포를 동일하게 구성하기 위해서 StratifiedKFold 교차검증을 수행하여 클래스의 분포를 유지했다.
  학습 결과로 각 모델에 의해 선정되 요인을 합친 뒤, 임계값 0.01/0.05를 기준으로 두개의 위험요인집합을 만들었다. 임계값 0.05를 기준으로 한 위험 요인은 흡연량, 흡연시작연령, 흡연기간 등을 포함한 10개 칼럼이며, 임계값 0.01을 기준으로 한 위험 요인은 첫 출산 연령, HRT 사용 여부 등을 포함한 19개 칼럼이다.
![image](https://github.com/user-attachments/assets/849562df-2fc0-419c-bcfd-e0e35a1fde7f)

## 유방암 위험 확률(유방암 위험 점수) 예측
 선정한 위험 요인들에 한정하여 GB, RF, ANN, Logistic Regression 을 학습시켜 유방암 위험 확률을 예측하였다. 모든 과정은 위험 요인 선정기준의 임계값이 0.01인 경우와 0.05 인 경우를 나눠 진행한다. 
### A. 사용 데이터
 최종 데이터에서 각각 임계값 0.01과 0.05 기준의 위험요인으로 선정된 칼럼들만 남기고 제외한 뒤 학습에 사용하였다. 
### B. 변수 중요도 추출
독립변수 X와 종속변수 y로 데이터를 나누어 모델에 적합시켜 독립변수에 대한 중요도를 추출한다. 독립 변수 X는 각 위험요인이며, 종속 변수 y는 유방암 유무이다. 모든 과정은 임계값 0.01의 경우와 0.05의 경우를 동시에 진행한다.
#### 1. GB(Gradient Boosting) 
  데이터 스케일링을 거쳐 GB를 이용하여 모델에 적합시켜 종속 변수 y에 기여하는 독립 변수 X의 중요도를 
구한다.
#### 2. RF(Random Forest) 
 위와 동일한 과정으로 RF를 이용하여 변수 중요도와 VIF FACTOR를 구한다. 
#### 3. ANN 
 데이터 스케일링을 거쳐 ANN에 적합한 하이퍼 파라미터를 조정한 후 모델에 적합시켜 가중치를 구한다.  
#### 4. Logistic Regression 
 위와 동일한 방식으로 LR모델에 적합시켜 오즈비를 계산한다. 이 과정에서 다중공선성 문제를 위해 변수들의 상관관계를 고려하였다.

### C. 유방암 위험 위험 확률(유방암 위험점수)
 각 모델의 변수 중요도(및 가중치 또는 오즈비)를 이용하여 각 행에 대한 예측 확률을 계산한다. 예측 확률을 이용하여 최종 유방암 위험 확률(유방암 위험 점수)를 도출한다. 모든 과정은 임계값 0.01의 경우와 0.05의 경우를 동시에 진행한다.
#### 1. GB
 B-1에서 구한 변수 중요도를 이용하여 위와 동일한 방식으로 위험 점수를 구한다. GB에서 환자군 데이터의 위험 점수 중 최대 위험 점수는 0.999970점으로 이를 max_risk_score로 설정한다. 
 이 수치를 분모로 전체 위험 점수를 100점 기준으로 변환하여 위험 백분위를 계산하였다. 이는 본 프로젝트에서 유방암 위험 확률이라 칭한다. 
 유방암 위험 확률(유방암 위험 점수)의 분포도는 [그림 4-2], [그림 4-3]와 같았다.
 ![image](https://github.com/user-attachments/assets/5a1f96ab-33eb-4915-822a-1fdb2d556fe0)
#### 2. RF 
 B-2에서 구한 변수 중요도를 이용하여 위와 동일한 방식으로 유방암 위험 확률을 도출한다. 
#### 3. ANN 
 B-3에서 구한 가중치를 이용하여 위와 동일한 방식으로 진행한다. 
#### 4. Logistic Regression 
 B-4에서 구한 오즈비를 이용하여 위와 동일한 방식으로 진행한다.
 ![image](https://github.com/user-attachments/assets/e80b9adb-73ec-4120-9163-ffad7fcb168a)
 
## 모델 성능 비교 분석
유방암 위험 확률(유방암 위험 점수) 예측에 사용되는 모델을 최종 선정하기 위해 모델의 성능을 비교 분석한다. 성능 비교 지표는 Accuracy, Precision, Recall, F1 Score, ROC AUC 를 기준으로 한다. 결과는 [표4-3], [표4-4]와 같았다.
![image](https://github.com/user-attachments/assets/aa97ca41-5f8e-4c24-89c2-6cbe5f1930bc)
임계값 0.01 이상 모델의 성능 비교에서 Accuracy, Precision, F1 Score, ROC AUC 가 가장 높은 값을 
갖는 Gradient Boosting 이 비교적 우수하다. 임계값 0.05 이상 모델의 성능 비교에서 Accuracy, Recall, F1 Score, ROC AUC 가 가장 높은 값을 갖는 Random Forest 가 비교적 우수하다. 

## 유방암 위험 확률(유방암 위험 점수) 정확도 분석
유방암 위험 확률(유방암 위험 점수) 정확도 분석 최종 선정된 모델의 유방암 위험 점수 정확도를 
분석한다. 정확도는 F1-Score 와 threshold 간 관계를 분석하여 F1-score가 가장 높은 threshold를 
Best Threshold 로 선택한다(부록17, 18).
![image](https://github.com/user-attachments/assets/86313f72-0b88-4855-8a23-13472dfd2e62)
 관계 분석 결과, 임계값 0.01 의 경우 Best Threshold 는 40.133142 이며, 0.05 의 경우는 53.906345 이다. 선택한 Threshold 를 기준으로 이진분류를 수행해 혼돈행렬을 만들었다. (부록19,20) 
![image](https://github.com/user-attachments/assets/fe9cc49c-5797-4bd8-9365-3946cf5f6383)
![image](https://github.com/user-attachments/assets/9955ddeb-6f3f-4456-9841-7172d6616719)
 임계값 0.01 의 경우 혼동행렬에 따른 Recall은 0.999439, 임계값 0.05의 경우 Recall은 0.984936이다.따라서 임계값 0.01이 더 적합하다. 임계값 0.01 이상의 유방암 위험 점수 분포도를 Threshold 를 기준으로 시각화 한 그래프는 [그림 4-4]와 같다.
 ![image](https://github.com/user-attachments/assets/42c86cd8-551a-4c9b-a3c2-f54a2514e325)
 위 그래프에서 가운데 점선은 Threshold를, ‘Target 0’은 대조군, ‘Target 1’은 환자군을 의미한다. 따라서 유방암 위험 점수가 Threshold를 기준으로 환자군과 대조군으로 나뉘므로, 점수가 정확하게 예측되었다고 볼 수 있다.  
